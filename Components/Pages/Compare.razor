@page "/compare"
@using BlazorTest.Services
@using BlazorTest.Services.Analytics
@inject CompareAnalysisServices CompareService
@inject LaundryStateService LaundryState
@rendermode InteractiveServer

<PageTitle>Compare</PageTitle>

<div class="compare-container">
        <div class="compare-selected-laundromats">
            <SelectedLaudromats />
        </div>

        <div class="compare-content">
            @if (isLoading)
            {
                <div>Loading comparison charts...</div>
            }
            else if (chartLabelsCompare.Length > 0)
            {
                <div class="compare-graph">
                    <ChartComponent CanvasId="compareTransactions"
                                    Labels="@chartLabelsCompare"
                                    MultiValues="@chartValuesCompare"
                                    DatasetLabels="@chartDatasetLabelsCompare"
                                    Title="Transactions Over Time"
                                    Type="line"
                                    Stacked="false" />
                </div>
                <div class="compare-graph">
                    <ChartComponent CanvasId="compareTransactionss"
                                    Labels="@chartLabelsCompare"
                                    MultiValues="@chartValuesCompare"
                                    DatasetLabels="@chartDatasetLabelsCompare"
                                    Title="Transactions Over Time"
                                    Type="line"
                                    Stacked="false" />
                </div>
            }
            else
            {
                <div>No data available for selected laundromats or date range.</div>
                <div>Loaded laundromats: @chartDatasetLabelsCompare.Length</div>
                <div>Labels: @string.Join(", ", chartLabelsCompare)</div>
            }
        </div>
</div>

@code {
    private bool isLoading = true;
    private bool isDataLoading = false;
    private CancellationTokenSource cts = new();

    private string[] chartLabelsCompare = Array.Empty<string>();
    private decimal[][] chartValuesCompare = Array.Empty<decimal[]>();
    private string[] chartDatasetLabelsCompare = Array.Empty<string>();

    private List<string> laundromatIds = new();
    private DateTime? startDate;
    private DateTime? endDate;

    protected override async Task OnInitializedAsync()
    {
        LaundryState.OnStateChanged += OnStateChanged;
        await LoadCompareData(cts.Token);
    }

    private void OnStateChanged()
    {
        InvokeAsync(HandleStateChanged);
    }

    private async Task HandleStateChanged()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            cts.Cancel();
            cts.Dispose();
            cts = new CancellationTokenSource();

            laundromatIds = LaundryState.GetEffectiveSelectedLaundromatsIds();
            startDate = LaundryState.GetStartDate();
            endDate = LaundryState.GetEndDate();

            await LoadCompareData(cts.Token);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error handling state change: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadCompareData(CancellationToken token)
    {
        if (isDataLoading) return;

        try
        {
            isDataLoading = true;

            laundromatIds = LaundryState.GetEffectiveSelectedLaundromatsIds();
            startDate = LaundryState.GetStartDate();
            endDate = LaundryState.GetEndDate();

            var safeStart = startDate ?? DateTime.Today.AddMonths(-6);
            var safeEnd = endDate ?? DateTime.Today;

            var compareTask = CompareService.CalcTransactionOverTimeCompare(
                laundromatIds,
                safeStart,
                safeEnd
            );

            await Task.WhenAll(compareTask);
            token.ThrowIfCancellationRequested();

            var raw = await compareTask;

            chartLabelsCompare = raw.Values
                .SelectMany(dict => dict.Keys)
                .Distinct()
                .OrderBy(label => label)
                .ToArray();

            chartDatasetLabelsCompare = raw.Keys.ToArray();
            chartValuesCompare = raw.Select(kvp =>
            {
                var monthDict = kvp.Value;
                return chartLabelsCompare
                    .Select(label => monthDict.TryGetValue(label, out var value) ? value : 0m)
                    .ToArray();
            }).ToArray();

            Console.WriteLine("Compare chart loaded with labels: " + string.Join(", ", chartLabelsCompare));
        }
        catch (OperationCanceledException)
        {
            Console.WriteLine("Compare data load canceled.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ComparePage error: {ex.Message}");
        }
        finally
        {
            isDataLoading = false;
            isLoading = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        LaundryState.OnStateChanged -= OnStateChanged;
        cts.Cancel();
        cts.Dispose();
    }
}
